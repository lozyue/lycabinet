!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("Lycabinet",[],e):"object"==typeof exports?exports.Lycabinet=e():t.Lycabinet=e()}(self,(function(){return(()=>{"use strict";var t={d:(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>h}),(()=>{const t=[];window.addEventListener("storage",(e=>{t.forEach((t=>{t(e)}))}),!1)})();const o=function(...t){let e;return t.reduce(((t,r)=>{for(let e in r)t[e]&&i(t[e])?o(t[e],r[e]):t[e]=r[e];return e=t,t}),t[0]),e},r=t=>null!=t,i=t=>"[object Object]"===Object.prototype.toString.call(t);var s="idle",n="loading";function a(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];this._init.apply(this,e)}!function(t){const e=Object.create(null);t.prototype.hasStore=function(){return r(e[this.__root])},t.prototype.getStore=function(){return e[this.__root]},t.prototype.setStore=function(t){e[this.__root]=t}}(a),function(t){t.prototype._setlog=new Function,t.prototype._once=new Function,t.prototype._trigger=new Function,t.prototype._off=new Function,t.prototype._on=new Function}(a),function(t){t.prototype._init=function(t,e={}){if(e.initStorage&&!i(e.initStorage))throw new Error("[Lycabinet]:The type of the provided option `initStorage` must be an Object!");if("string"!=typeof(r=t)||r.constructor!=String)throw new Error(`[Lycabinet]: The param "root" should be an string, than type ${typeof t}!`);var r;this.__root=(t||"lycabinet")+"";const s={root:this.__root,autoload:!0,lazyPeriod:~~e.lazyPeriod||5e3,saveMutex:!0,autoLazy:!0,logEvent:!1,useSharedCabinet:!0,shareCabinet:!0,localInterface:{database:window.localStorage,getItem:"getItem",setItem:"setItem",removeItem:"removeItem"},concurrence:!(e.outerLoad&&e.outerSave&&e.outerClear),outerLoad:([t,e],o,r)=>{o({})},outerSave:([t,e],o,r)=>{o()},outerClear:([t,e],o,r)=>{o()}};this.options=o(s,e),this.__install(this.options),this.options.logEvent&&this._setlog(),this.status="created",this._trigger("created"),this.options.autoload&&this.__init(e.initStorage||Object.create(null))},t.prototype.__init=function(t=Object.create(null)){const e=function(){var t,e;(t=this.__tempStorage)&&(e=t,Array.isArray&&Array.isArray(e)||"object"==typeof e&&e.constructor==Array?t.length:Object.keys(t).length)&&(o(this.__storage,this.__tempStorage),this.__tempStorage=Object.create(null),this._trigger("writeBackflow"))};return this._on("loaded",e),this._on("cleared",e),this.options.useSharedCabinet&&this.hasStore()?(this._trigger("loadingFromCache"),this.__storage=this.getStore()):(this.__storage=this.__storage||t,this.options.shareCabinet&&this.setStore(this.__storage),this.options.autoload?this.load(!1):this.status=s),this.status="mounted",this._trigger("mounted"),this},t.prototype.isVacant=function(){return this.status===s},t.prototype.set=function(t,e){return[n,"clearing"].indexOf(this.status)>-1?(this._trigger("writeLock"),this.__tempStorage=this.__tempStorage||(this.__tempStorage=Object.create(null)),this.__tempStorage[t]=e,this):(this.__storage[t]=e,this._trigger("setItem",t,e),this)},t.prototype.get=function(t){let e=this.__storage[t];return this._trigger("getItem",t,e),e},t.prototype.remove=function(t){let e=!1;var o,r;return r=t=>{this.__storage.hasOwnProperty(t)&&(this.set(t,void 0),e=!0)},(o=t).forEach?o.forEach(r):r(o),this._trigger("removeItem",t,e),this},t.prototype.clear=function(t=null,e=null){e=r(e)?e:this.options.concurrence,t=r(t)?t:!!this.options.outerClear,this.status=n,this._trigger("beforeClear");let o=()=>{const o=t&&!e;if(this._trigger("beforeLocalClear",o),o)return this;const r=this.options.localInterface;r.database[r.removeItem](this.__root),this._trigger("localCleared",this.__root)};const i=[this.__root,this.__storage],a=()=>{this.status=s,this._trigger("cleared",t,e)},h=(o,r="")=>{this._trigger("error","clear","cloudClearings",r),this.status=s,this._trigger("cleared",t,e),console.error(`[Lycabinet]: Failed to Clear the cabinet "${this.__root}" on cloud. ${o}`)};try{o(),t?this.options.outerClear(i,a,h):(this.status=s,this._trigger("cleared",t,e))}catch(t){h(t,"unknown")}return this},t.prototype.load=function(t=!1,e=null,a=null){a=r(a)?a:this.options.concurrence,e=r(e)?e:!!this.options.outerLoad,this.status=n,this._trigger("beforeLoad");let h=()=>{let r=null;const i=e&&!a;if(this._trigger("beforeLocalLoad",i),i)return this;const s=this.options.localInterface;let n=s.database[s.getItem](this.__root);n=this._trigger("localLoaded",n),r=JSON.parse(n),t?o(this.__storage,r):Object.assign(this.__storage,r)};const c=[this.__root,this.__storage],_=n=>{if(!r(n)||!i(n))throw new Error("[Lycabinet]: Load cabinet with empty 'data' which type is "+typeof n);t?o(this.__storage,n):Object.assign(this.__storage,n),this.status=s,this._trigger("loaded",e,a)},l=(t,o="")=>{this._trigger("error","load","cloudLoadings",o),this.status=s,this._trigger("loaded",e,a),console.error(`[Lycabinet]: Failed to Load the cabinet "${this.__root}" on cloud. ${t}`)};try{h(),e?this.options.outerLoad(c,_,l):(this.status=s,this._trigger("loaded",e,a))}catch(t){l(t,"unknown")}return this},t.prototype.save=function(t=null,e=null){let o=this.options.saveMutex&&!this.isVacant();if(this._trigger("beforeSave",o),o)return this._trigger("busy"),this.options.autoLazy&&this.lazySave(t,e),this;t=r(t)?t:!!this.options.outerSave,e=r(e)?e:this.options.concurrence,this.status="saving";let i=()=>{const o=t&&!e;if(this._trigger("beforeLocalSave",o),o)return this;const r=this.options.localInterface;let i=JSON.stringify(this.__storage);i=this._trigger("localSaved",i),r.database[r.setItem](this.__root,i)};const n=[this.__root,this.__storage],a=()=>{this.status=s,this._trigger("saved",t,e)},h=(o,r="cloudSavings")=>{this._trigger("error","save",r),this.status=s,this._trigger("saved",t,e),console.error(`[Lycabinet]: Failed to Save the cabinet "${this.__root}" on cloud. ${o}`)};try{i(),t?this.options.outerSave(n,a,h):(this.status=s,this._trigger("saved",t,e))}catch(t){h(t,"unknown")}return this},t.prototype.forEach=function(t){let e,o=0;for(let r in this.__storage)e=this.__storage[r],t(e,o++)},t.prototype.map=function(t){let e,o=0;for(let r in this.__storage)e=this.__storage[r],this.__storage[r]=t(e,o++)}}(a),function(t){var e;t.prototype.lazySave=(e=0,function(...t){var o=(new Date).getTime();let r=o-e>5e3;return this._trigger("lazySave",r),r&&(e=o,console.log("Lazy executed!",o,e,r),this.save(...t)),this}),t.prototype.lazySet=function(t,e,...o){return this.set(t,e).lazySave(...o),this}}(a),function(t){t.prototype._mixins=[],t.mixin=function(e){return t.prototype._mixins.push(e),this},t.prototype.__install=function(...e){e.unshift(this),t.prototype._mixins.forEach((t=>{t.apply(t,e)}))}}(a);const h=a;return e.default})()}));
//# sourceMappingURL=lycabinet.light.min.js.map