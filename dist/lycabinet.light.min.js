!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("Lycabinet",[],e):"object"==typeof exports?exports.Lycabinet=e():t.Lycabinet=e()}(self,(function(){return(()=>{"use strict";var t={d:(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>h}),(()=>{const t=[];window.addEventListener("storage",(e=>{t.forEach((t=>{t(e)}))}),!1)})();const o=function(...t){let e;return t.reduce(((t,r)=>{for(let e in r)t[e]&&i(t[e])?o(t[e],r[e]):t[e]=r[e];return e=t,t}),t[0]),e},r=t=>null!=t,i=t=>"[object Object]"===Object.prototype.toString.call(t);const s="[Lycabinet]: ",n="idle",a="loading";function c(...t){this.__init.apply(this,t)}!function(t){const e=Object.create(null);t.prototype.hasStore=function(){return r(e[this.__root])&&i(e[this.__root])},t.prototype.getStore=function(){return e[this.__root]},t.prototype.setStore=function(t){e[this.__root]=t},t.prototype.removeStore=function(){e[this.__root]=void 0},t.$removeStore=function(t){e[t]=void 0}}(c),function(t){const e=t.prototype,o=new Function;e._isHappend=o,e._setlog=o,e._once=o,e._trigger=o,e._off=o,e._on=o}(c),function(t){t.DEBUG=!0,t.SeparateLog=!1;const e=t.prototype;e.__init=function(t,e={}){if(e.initStorage&&!i(e.initStorage))throw new Error(`${s}The type of the provided option "initStorage" must be an Object!`);if("string"!=typeof(r=t)||r.constructor!=String)throw new Error(`${s}The param "root" should be an string, than type ${typeof t}!`);var r;this.__root=(t||"lycabinet")+"";const n={root:this.__root,autoload:!0,lazyPeriod:~~e.lazyPeriod||5e3,saveMutex:!0,autoLazy:!0,logEvent:!1,useSharedCabinet:!0,shareCabinet:!0,deepMerge:!1,localInterface:{database:window.localStorage,getItem:"getItem",setItem:"setItem",removeItem:"removeItem"},concurrent:!!(e.outerLoad||e.outerSave||e.outerClear),outerLoad:null,outerSave:null,outerClear:null};this.options=o(n,e),this.__install(n),n.logEvent&&this._setlog(),this.status="created",this._trigger("created"),n.autoload&&this._init(e.initStorage||Object.create(null))},e._init=function(t=Object.create(null)){const e=function(){var t,e;(t=this.__tempStorage)&&(e=t,Array.isArray&&Array.isArray(e)||e instanceof Array||"object"==typeof e&&"Array"===Object.prototype.toString.call(e).slice(-6,-1)?t.length:Object.keys(t).length)&&(o(this.__storage,this.__tempStorage),this.__tempStorage=Object.create(null),this._trigger("writeBackflow"))};this._on("loaded",e),this._on("cleared",e);const r=this.options.useSharedCabinet&&this.hasStore();return r?(this.__storage=this.getStore(),Object.assign(t,this.__storage),this._trigger("loadFromCache")):(this.__storage=this.__storage||t,this.options.shareCabinet&&this.setStore(this.__storage)),this.status="mounted",this._trigger("mounted"),r||(this.options.autoload?this.load():this.status=n),this},e.isVacant=function(){return this.status===n},e.set=function(t,e){return[a,"clearing"].indexOf(this.status)>-1?(this._trigger("writeLock"),this.__tempStorage=this.__tempStorage||(this.__tempStorage=Object.create(null)),this.__tempStorage[t]=e,this):(this.__storage[t]=e,this._trigger("setItem",t,e),this)},e.get=function(t){let e=this.__storage[t];return this._trigger("getItem",t,e),e},e.remove=function(t){let e=!1;var o,r;return r=t=>{this.__storage.hasOwnProperty(t)&&(this.set(t,void 0),e=!0)},(o=t).forEach?o.forEach(r):r(o),e&&this._trigger("removeItem",t,e),this},e.clear=function(t={}){const e=r(t.concurrent)?t.concurrent:this.options.concurrent,o=r(t.onCloud)?t.onCloud:!!this.options.outerClear;this.status=a,this._trigger("beforeClear");let i=()=>{const t=o&&!e;if(this._trigger("beforeLocalClear",t),t)return this;const r=this.options.localInterface;r.database[r.removeItem](this.__root),this._trigger("localCleared",this.__root)};const c=[this.__root,this.__storage],h=()=>{this.status=n,this._trigger("cleared",o,e),t.onceDone&&t.onceDone(!0,o)},u=(r,i="cloudClearings")=>{this._trigger("error","clear",i),this.status=n,this._trigger("cleared",o,e),o&&console.error(`${s}Failed to Clear the cabinet "${this.__root}" on cloud. ${r}`),t.onceDone&&t.onceDone(!1,o)};try{i(),o?this.options.outerClear(c,h,u):(this.status=n,this._trigger("cleared",o,e),t.onceDone&&t.onceDone(!0,o))}catch(t){u(t,"unknown")}return this},e.load=function(t={}){const e=r(t.concurrent)?t.concurrent:this.options.concurrent,c=r(t.onCloud)?t.onCloud:!!this.options.outerLoad,h=r(t.deepMerge)?~~t.deepMerge:this.options.deepMerge;this.status=a,this._trigger("beforeLoad");let u=()=>{let t=null;const r=c&&!e;if(this._trigger("beforeLocalLoad",r),r)return this;const i=this.options.localInterface;let s=i.database[i.getItem](this.__root);s=this._trigger("localLoaded",s),t=JSON.parse(s),h?o(this.__storage,t):Object.assign(this.__storage,t)};const _=[this.__root,this.__storage],g=a=>{if(!r(a)||!i(a))throw new Error(`${s}Load cabinet with empty 'data' which type is ${typeof a}`);h?o(this.__storage,a):Object.assign(this.__storage,a),this.status=n,this._trigger("loaded",c,e),t.onceDone&&t.onceDone(!0,c)},l=(o,r="cloudLoadings")=>{this._trigger("error","load",r),this.status=n,this._trigger("loaded",c,e),c&&console.error(`${s}Failed to Load the cabinet "${this.__root}" on cloud. ${o}`),t.onceDone&&t.onceDone(!1,c)};try{u(),c?this.options.outerLoad(_,g,l):(this.status=n,this._trigger("loaded",c,e),t.onceDone&&t.onceDone(!0,c))}catch(t){l(t,"unknown")}return this},e.save=function(t={}){const e=r(t.onCloud)?t.onCloud:!!this.options.outerSave,o=r(t.concurrent)?t.concurrent:this.options.concurrent;let i=this.options.saveMutex&&!this.isVacant();if(this._trigger("beforeSave",i),i)return this._trigger("busy",this.status),this.options.autoLazy&&this.lazySave(e,o),this;this.status="saving";let a=()=>{const t=e&&!o;if(this._trigger("beforeLocalSave",t),t)return this;let r=JSON.stringify(this.__storage);r=this._trigger("localSaved",r);const i=this.options.localInterface;i.database[i.setItem](this.__root,r)};const c=[this.__root,this.__storage],h=()=>{this.status=n,this._trigger("saved",e,o),t.onceDone&&t.onceDone(!0,e)},u=(r,i="cloudSavings")=>{this._trigger("error","save",i),this.status=n,this._trigger("saved",e,o),e&&console.error(`${s}Failed to Save the cabinet "${this.__root}" on cloud. ${r}`),t.onceDone&&t.onceDone(!1,e)};try{a(),e?this.options.outerSave(c,h,u):(this.status=n,this._trigger("saved",e,o),t.onceDone&&t.onceDone(!0,e))}catch(t){u(t,"unknown")}return this},e.forEach=function(t){let e,o=0;const r=this.__storage;for(let i in r)e=r[i],t(e,o++,r)},e.map=function(t){let e;const o=this.__storage;for(let r in o)e=o[r],o[r]=t(e,r,o)},e.destroy=function(){this._trigger("destroied")}}(c),function(t){var e;t.prototype.lazySave=(e=0,function(...t){var o=(new Date).getTime();let r=o-e>5e3;return this._trigger("lazySave",r),r&&(e=o,this.save(...t)),this}),t.prototype.lazySet=function(t,e,...o){return this.set(t,e).lazySave(...o),this}}(c),function(t){t.prototype._mixins=[],t.mixin=function(e){return t.prototype._mixins.push(e),this},t.prototype.__install=function(...e){e.unshift(this),t.prototype._mixins.forEach((t=>{t.apply(t,e)}))}}(c),function(t){const e=t.prototype;e.delete=e.remove,e.read=e.get,e.storage=e.getStore,e.getCabinet=e.getStore}(c);const h=c;return e.default})()}));
//# sourceMappingURL=lycabinet.light.min.js.map