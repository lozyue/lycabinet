!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("Lycabinet",[],e):"object"==typeof exports?exports.Lycabinet=e():t.Lycabinet=e()}(self,(function(){return(()=>{"use strict";var t={d:(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>b});const o=function(t,e){if(void 0===t[e=(t.length+e)%t.length])throw new Error(`The index ${e} in array ${t.toString()} is overflowed!`);return t[e]};function n(t,e){let o=t,n="";for(let t=0;t<e.length;t++)if(n=e[t],o=o&&o[n],void 0===o)return;return o}const r=(()=>{const t=[];return window.addEventListener("storage",(e=>{t.forEach((t=>{t(e)}))}),!1),(e,o=!1)=>{o?u(t,e):t.push(e)}})(),i=function(...t){let e;return t.reduce(((t,o)=>{for(let e in o)t[e]&&c(t[e])?i(t[e],o[e]):t[e]=o[e];return e=t,t}),t[0]),e};function s(t,e){if(!t)return e;let o=null;for(let n in e)if(o=t[n],a(o)){if(!c(o))continue;s(o,e[n])}else t[n]=e[n];return t}const a=t=>null!=t,c=t=>"[object Object]"===Object.prototype.toString.call(t),l=t=>t instanceof Function;var u=(t,e)=>{if(t.length){let o=t.indexOf(e);if(o>-1)return t.splice(o,1)}};const h="idle",g="loading";let f=null;function _(t,e=!0,o=!1){const n=[],r=t=>{n.unshift(t);for(let e in t)c(t[e])&&r(t[e])};return r(t),n.forEach(((t,n,r)=>{for(let i in t)c(t[i])&&(r[n][i]=p(t[i],e,o))})),p(t,e,o)}function p(t,e=!1,o=!0){let n=Object.create(null);n._parent=null,n.triggers=[],n.value=t;const r={enumerable:!1,configurable:!0,writable:!1},i=t=>n.triggers.push(t),s=t=>u(n.triggers,t),a=["$addListener","$removeListener"];a.forEach(((t,e)=>{n[t]={value:null},Object.defineProperty(n,t,{value:e?s:i,...r})}));const h=n.value;return new Proxy(t,{get:(t,e,o)=>a.indexOf(e)>-1?n[e]:h[e],set(t,r,i,s){const a=h[r];if(e?c(i)&&(h[r]=o?p(i,!1,!0):_(i,e,!1)):h[r]=i,i!==a){let t=n.triggers;for(let e=0;e<t.length;e++){if(!l(t[e]))throw new Error("The get proxy handler listener added in target is Not a Function which type is "+typeof t[e]);t[e](r,i,a)}null!==f&&f()}return!0}})}const d="cabinetSyncTabs";function y(...t){this.__init.apply(this,t)}!function(t){const e=Object.create(null);t.prototype.hasStore=function(){return a(e[this.__root])&&c(e[this.__root])},t.prototype.getStore=function(){return e[this.__root]},t.prototype.setStore=function(t){e[this.__root]=t},t.prototype.removeStore=function(){e[this.__root]=void 0},t.$removeStore=function(t){e[t]=void 0}}(y),function(t){t.prototype._mixins=[],t.mixin=function(e){return t.prototype._mixins.push(e),this},t.prototype.__install=function(...e){e.unshift(this),t.prototype._mixins.forEach((t=>{t.apply(t,e)}))}}(y),function(t){let e=null;t.mixin((function(n){let r=null;n!==e&&(r=Object.create(null)),e=n,n._on=function(t,e){r||(r=Object.create(null)),(r[t]||(r[t]=[])).push(e)},n._off=function(t,e){const o=r[t]||(r[t]=[]);u(o,e)},n._trigger=function(t,...e){const n=r[t]||(r[t]=[]),i=[];e.push(i);for(let t=0;t<n.length;t++){let o=n[t].apply(this,e);o&&i.push(o)}return n.counter||(n.counter=0),n.counter++,i.length?o(i,-1):e.length?o(e,-1):null},n._once=function(t,e,o=0){const n=r[t]||(r[t]=[]);if(n.counter&&~~o<=n.counter)e(n.counter);else{var i=function(...o){e.apply(this,o),this._off(t,i)};this._on(t,i)}},t.prototype._setlog=function(){new Set(Object.keys(r).concat(["created","mounted","beforeLoad","beforeLocalLoad","localLoaded","loaded","loadFromCache","setItem","writeLock","writeBackflow","getItem","removeItem","lazySave","beforeSave","beforeLocalSave","localSaved","saved","busy","beforeClear","beforeLocalClear","localCleared","cleared","error"])).forEach((t=>{let e=r[t]&&r[t]._logHandle;e&&this._off(t,e);const o=()=>{console.log(`[Lycabinet]: Triggered the event: '${t}'`)};this._on(t,o),r[t]._logHandle=o}))}}))}(y),function(t){t.prototype.__init=function(t,e={}){if(e.initStorage&&!c(e.initStorage))throw new Error("[Lycabinet]:The type of the provided option `initStorage` must be an Object!");if("string"!=typeof(o=t)||o.constructor!=String)throw new Error(`[Lycabinet]: The param "root" should be an string, than type ${typeof t}!`);var o;this.__root=(t||"lycabinet")+"";const n={root:this.__root,autoload:!0,lazyPeriod:~~e.lazyPeriod||5e3,saveMutex:!0,autoLazy:!0,logEvent:!1,useSharedCabinet:!0,shareCabinet:!0,deepMerge:!1,localInterface:{database:window.localStorage,getItem:"getItem",setItem:"setItem",removeItem:"removeItem"},concurrence:!(e.outerLoad&&e.outerSave&&e.outerClear),outerLoad:([t,e],o,n)=>{o({})},outerSave:([t,e],o,n)=>{o()},outerClear:([t,e],o,n)=>{o()}};this.options=i(n,e),this.__install(this.options),this.options.logEvent&&this._setlog(),this.status="created",this._trigger("created"),this.options.autoload&&this._init(e.initStorage||Object.create(null))},t.prototype._init=function(t=Object.create(null)){const e=function(){var t,e;(t=this.__tempStorage)&&(e=t,Array.isArray&&Array.isArray(e)||e instanceof Array||"object"==typeof e&&"Array"===Object.prototype.toString.call(e).slice(-6,-1)?t.length:Object.keys(t).length)&&(i(this.__storage,this.__tempStorage),this.__tempStorage=Object.create(null),this._trigger("writeBackflow"))};return this._on("loaded",e),this._on("cleared",e),this.options.useSharedCabinet&&this.hasStore()?(this.__storage=this.getStore(),Object.assign(t,this.__storage),this._trigger("loadFromCache")):(this.__storage=this.__storage||t,this.options.shareCabinet&&this.setStore(this.__storage),this.options.autoload?this.load(!1):this.status=h),this.status="mounted",this._trigger("mounted"),this},t.prototype.isVacant=function(){return this.status===h},t.prototype.set=function(t,e){return[g,"clearing"].indexOf(this.status)>-1?(this._trigger("writeLock"),this.__tempStorage=this.__tempStorage||(this.__tempStorage=Object.create(null)),this.__tempStorage[t]=e,this):(this.__storage[t]=e,this._trigger("setItem",t,e),this)},t.prototype.get=function(t){let e=this.__storage[t];return this._trigger("getItem",t,e),e},t.prototype.remove=function(t){let e=!1;var o,n;return n=t=>{this.__storage.hasOwnProperty(t)&&(this.set(t,void 0),e=!0)},(o=t).forEach?o.forEach(n):n(o),this._trigger("removeItem",t,e),this},t.prototype.clear=function(t={}){const e=a(t.concurrent)?t.concurrent:this.options.concurrence,o=a(t.onCloud)?t.onCloud:!!this.options.outerClear;this.status=g,this._trigger("beforeClear");let n=()=>{const t=o&&!e;if(this._trigger("beforeLocalClear",t),t)return this;const n=this.options.localInterface;n.database[n.removeItem](this.__root),this._trigger("localCleared",this.__root)};const r=[this.__root,this.__storage],i=()=>{this.status=h,this._trigger("cleared",o,e),t.onceDone&&t.onceDone(!0,o)},s=(n,r="")=>{this._trigger("error","clear","cloudClearings",r),this.status=h,this._trigger("cleared",o,e),console.error(`[Lycabinet]: Failed to Clear the cabinet "${this.__root}" on cloud. ${n}`),t.onceDone&&t.onceDone(!1,o)};try{n(),o?this.options.outerClear(r,i,s):(this.status=h,this._trigger("cleared",o,e),t.onceDone&&t.onceDone(!0,o))}catch(e){s(e,"unknown"),t.onceDone&&t.onceDone(!1,o)}return this},t.prototype.load=function(t={}){const e=a(t.concurrent)?t.concurrent:this.options.concurrence,o=a(t.onCloud)?t.onCloud:!!this.options.outerLoad,n=a(t.deepMerge)?~~t.deepMerge:this.options.deepMerge;this.status=g,this._trigger("beforeLoad");let r=()=>{let t=null;const r=o&&!e;if(this._trigger("beforeLocalLoad",r),r)return this;const s=this.options.localInterface;let a=s.database[s.getItem](this.__root);a=this._trigger("localLoaded",a),t=JSON.parse(a),n?i(this.__storage,t):Object.assign(this.__storage,t)};const s=[this.__root,this.__storage],l=r=>{if(!a(r)||!c(r))throw new Error("[Lycabinet]: Load cabinet with empty 'data' which type is "+typeof r);n?i(this.__storage,r):Object.assign(this.__storage,r),this.status=h,this._trigger("loaded",o,e),t.onceDone&&t.onceDone(!0,o)},u=(n,r="")=>{this._trigger("error","load","cloudLoadings",r),this.status=h,this._trigger("loaded",o,e),console.error(`[Lycabinet]: Failed to Load the cabinet "${this.__root}" on cloud. ${n}`),t.onceDone&&t.onceDone(!1,o)};try{r(),o?this.options.outerLoad(s,l,u):(this.status=h,this._trigger("loaded",o,e),t.onceDone&&t.onceDone(!0,o))}catch(e){u(e,"unknown"),t.onceDone&&t.onceDone(!1,o)}return this},t.prototype.save=function(t={}){const e=a(t.onCloud)?t.onCloud:!!this.options.outerSave,o=a(t.concurrent)?t.concurrent:this.options.concurrence;let n=this.options.saveMutex&&!this.isVacant();if(this._trigger("beforeSave",n),n)return this._trigger("busy"),this.options.autoLazy&&this.lazySave(e,o),this;this.status="saving";let r=()=>{const t=e&&!o;if(this._trigger("beforeLocalSave",t),t)return this;const n=this.options.localInterface;let r=JSON.stringify(this.__storage);r=this._trigger("localSaved",r),n.database[n.setItem](this.__root,r)};const i=[this.__root,this.__storage],s=()=>{this.status=h,this._trigger("saved",e,o),t.onceDone&&t.onceDone(!0,e)},c=(n,r="cloudSavings")=>{this._trigger("error","save",r),this.status=h,this._trigger("saved",e,o),console.error(`[Lycabinet]: Failed to Save the cabinet "${this.__root}" on cloud. ${n}`),t.onceDone&&t.onceDone(!1,e)};try{r(),e?this.options.outerSave(i,s,c):(this.status=h,this._trigger("saved",e,o),t.onceDone&&t.onceDone(!0,e))}catch(o){c(o,"unknown"),t.onceDone&&t.onceDone(!1,e)}return this},t.prototype.forEach=function(t){let e,o=0;for(let n in this.__storage)e=this.__storage[n],t(e,o++)},t.prototype.map=function(t){let e,o=0;for(let n in this.__storage)e=this.__storage[n],this.__storage[n]=t(e,o++)}}(y),function(t){var e;t.prototype.lazySave=(e=0,function(...t){var o=(new Date).getTime();let n=o-e>5e3;return this._trigger("lazySave",n),n&&(e=o,this.save(...t)),this}),t.prototype.lazySet=function(t,e,...o){return this.set(t,e).lazySave(...o),this}}(y),function(t){t.install=function(e,o){t.mixin((function(t){s(t.options,{useLaction:{lazyOrbitId:-1}}),e.registerHook({name:t.__root+"_lazysave",once:!0,debounce:!0,actions:(...e)=>{t.save(...e)}})})),t.prototype.lazySave=function(...t){return t.unshift(`${this.__root}_lazysave`),e.bubble(t,this.options.useLaction.lazyOrbitId),this}}}(y),function(t){t.prototype.delete=t.prototype.remove,t.prototype.read=t.prototype.get,t.prototype.storage=t.prototype.getStore,t.prototype.getCabinet=t.prototype.getStore}(y),function(t){t.mixin((function(t){const e=t.options;e.includes&&e.excludes?this.setFilter():s(e,{includes:[],excludes:[]})})),t.prototype.setFilter=function(){const t=this;Object.defineProperty(this.getStore(),"toJSON",{configurable:!0,enumerable:!1,value:function(){let e=Object.create(null);if(t.options.includes.length>0){let o=[];t.options.includes.forEach(((n,r)=>{let i=o[r]=n.split("."),s=t.__storage;i.forEach(((t,o)=>{s=s[i[o]],o+1<i.length&&a(s)?a(e[i[o]])?Object.assign(e[i[o]],s):e[i[o]]={}:e[i[o]]=s}))}))}else Object.assign(e,t.__storage);let o=[];return t.options.excludes.forEach(((t,n,r)=>{let i=o[n]=t.split("."),s=e;for(let t=0;t<i.length&&a(e[i[0]])&&a(s[i[t]]);t++)s=s[i[t]],t===r.length-1&&(s=void 0)})),e}})}}(y),function(t){t.prototype.initObserver=function(t={}){if(Object.assign(t,{deepMerge:!0}),s(t,{lazy:!0,initWatch:!0,deepWatch:!0,shallowWatch:!1}),f=()=>{t.lazy?this.lazySave():this.save()},!t.initWatch)return!1;this.__storage=_(this.__storage,t.deepWatch,t.shallowWatch),this.setStore(this.__storage)},t.$set=function(t,e,o=!1,n=!0){return function(t,e,o=null){let n=t,r="",i=0;for(;i<e.length-1;i++)if(r=e[i],a(n[r])){if(!((s=n[r])instanceof Object||"object"==typeof s))return i;n=n[r]}else n=n[r]={};var s;return r=e[i],l(o)?o(n,r):n[r]=o,!0}(t,e,((t,e)=>{c(t[e])||(t[e]={}),t[e]=p(t[e],o,n)}))},t.$get=function(t,e){return n(t,e)},t.prototype.$set=function(e,o=!1,n=!0){return t.$set(this.__storage,e.split("."),o,n)},t.prototype.$get=function(t){return n(this.__storage,t.split("."))}}(y),function(t){t.mixin((function(t){t._on("localLoaded",(function(t,e){let n=e.length?o(e,-1):t;return n||(n="{}"),n})),t._on("localSaved",(function(t,e){return e.length?o(e,-1):t}))})),t.mixin((function(t){t._on("setItem",(function(){this._dirty=!0})),t._on("saved",(function(){this._dirty=!1}))}));var e={};r((t=>{if(!e.cabinetIns)return!0;const{cabinetIns:o}=e;if(o.useLoadCache)return!0;[o.__root,d].indexOf(t.key)>-1&&o.load(!0,!1,!0)})),t.mixin((function(t){e.cabinetIns=t,t._on("loadFromCache",(function(){this.useLoadCache=!0})),function(t,e){let o=null;for(let n in e)o=t[n],a(o)||(t[n]=e[n])}(t.options,{autoNotifyTabs:!1}),t._on("saved",(function(t,e){if(this.options.autoNotifyTabs){if(t&&!e)return!1;this.notifyTabs()}}))})),t.prototype.notifyTabs=function(){const t=(new Date).getTime();window.localStorage.setItem(d,t+"")}}(y),function(t){t.mixin((function(t){t._on("localLoaded",(function(t,e){return e.length?o(e,-1):t})),t._on("localSaved",(function(t,e){return e.length?o(e,-1):t}))}))}(y);const b=y;return e.default})()}));
//# sourceMappingURL=lycabinet.min.js.map