!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("Lycabinet",[],e):"object"==typeof exports?exports.Lycabinet=e():t.Lycabinet=e()}(self,(function(){return(()=>{"use strict";var t={d:(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>d});const o=function(t,e){if(void 0===t[e=(t.length+e)%t.length])throw console.log(t,e),new Error(`The index ${e} in array ${t.toString()} is overflowed!`);return t[e]},r=(()=>{const t=[];return window.addEventListener("storage",(e=>{t.forEach((t=>{t(e)}))}),!1),(e,o=!1)=>{o?c(t,e):t.push(e)}})(),i=function(...t){let e;return t.reduce(((t,o)=>{for(let e in o)t[e]&&a(t[e])?i(t[e],o[e]):t[e]=o[e];return e=t,t}),t[0]),e};function n(t,e){let o=null;for(let r in e)if(o=t[r],s(o)){if(!a(o))continue;n(o,e[r])}else t[r]=e[r];return t}const s=t=>null!=t,a=t=>"[object Object]"===Object.prototype.toString.call(t);var c=(t,e)=>{if(t.length){let o=t.indexOf(e);if(o>-1)return t.splice(o,1)}};var l="idle",h="loading";let u=null;function g(t,e=!0,o=!1){const r=[],i=t=>{r.unshift(t);for(let e in t)a(t[e])&&i(t[e])};return i(t),r.forEach(((t,r,i)=>{for(let n in t)a(t[n])&&(i[r][n]=_(t[n],e,o))})),_(t,e,o)}function _(t,e=!1,o=!0){let r=Object.create(null);r._parent=null;const i=(t,e)=>void 0!==r[e]&&r[e].trigger.push(t),n=(t,e)=>void 0!==r[e]&&c(r[e].trigger,t),s={enumerable:!1,configurable:!0,writable:!1};for(let e in t)r[e]={value:t[e],trigger:[]};return["$addListener","$removeListener"].forEach(((t,e)=>{r[t]={value:null},Object.defineProperty(r[t],"value",{value:e?n:i,...s})})),new Proxy(t,{get:(t,e,o)=>void 0===r[e]?void 0:r[e].value,set(t,i,n,s){r[i]=r[i]||{value:n,trigger:[]};let c=r[i].value;if(e?a(n)&&(r[i].value=o?_(n,!1,!0):g(n,e,!1)):r[i].value=n,c!==n){let t=r[i].trigger;for(let e=0;e<t.length;e++)t[e](c,n)}return!0}})}const f="cabinetSyncTabs";function p(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];this._init.apply(this,e)}!function(t){const e=Object.create(null);t.prototype.hasStore=function(){return s(e[this.__root])},t.prototype.getStore=function(){return e[this.__root]},t.prototype.setStore=function(t){e[this.__root]=t}}(p),function(t){const e=Object.create(null);t.prototype._on=function(t,o){if("function"!=typeof(r=o)||r.constructor!=Function)throw new Error("[Laction]:The second parameter of _on method must be a callback function!");var r;(e[t]||(e[t]=[])).push(o)},t.prototype._off=function(t,o){const r=e[t]||(e[t]=[]);c(r,o)},t.prototype._trigger=function(t,...r){const i=e[t]||(e[t]=[]),n=[];r.push(n);for(let t=0;t<i.length;t++){let e=i[t].apply(this,r);e&&n.push(e)}return n.length?o(n,-1):r.length?o(r,-1):null},t.prototype._once=function(t,e){const o=this;var r=function(...i){e.apply(o,i),o._off(t,r)};this._on(t,r)},t.prototype._setlog=function(){new Set(Object.keys(e).concat(["created","mounted","beforeLoad","beforeLocalLoad","localLoaded","loaded","loadingFromCache","setItem","writeLock","writeBackflow","getItem","removeItem","lazySave","beforeSave","beforeLocalSave","localSaved","saved","busy","beforeClear","beforeLocalClear","localCleared","cleared","error"])).forEach((t=>{let o=e[t]&&e[t]._logHandle;o&&this._off(t,o);const r=()=>{console.log(`[Lycabinet]: Triggered the event: '${t}'`)};this._on(t,r),e[t]._logHandle=r}))}}(p),function(t){t.prototype._init=function(t,e={}){if(e.initStorage&&!a(e.initStorage))throw new Error("[Lycabinet]:The type of the provided option `initStorage` must be an Object!");if("string"!=typeof(o=t)||o.constructor!=String)throw new Error(`[Lycabinet]: The param "root" should be an string, than type ${typeof t}!`);var o;this.__root=(t||"lycabinet")+"";const r={root:this.__root,autoload:!0,lazyPeriod:~~e.lazyPeriod||5e3,saveMutex:!0,autoLazy:!0,logEvent:!1,useSharedCabinet:!0,shareCabinet:!0,localInterface:{database:window.localStorage,getItem:"getItem",setItem:"setItem",removeItem:"removeItem"},concurrence:!(e.outerLoad&&e.outerSave&&e.outerClear),outerLoad:([t,e],o,r)=>{o({})},outerSave:([t,e],o,r)=>{o()},outerClear:([t,e],o,r)=>{o()}};this.options=i(r,e),this.__install(this.options),this.options.logEvent&&this._setlog(),this.status="created",this._trigger("created"),this.options.autoload&&this.__init(e.initStorage||Object.create(null))},t.prototype.__init=function(t=Object.create(null)){const e=function(){var t,e;(t=this.__tempStorage)&&(e=t,Array.isArray&&Array.isArray(e)||"object"==typeof e&&e.constructor==Array?t.length:Object.keys(t).length)&&(i(this.__storage,this.__tempStorage),this.__tempStorage=Object.create(null),this._trigger("writeBackflow"))};return this._on("loaded",e),this._on("cleared",e),this.options.useSharedCabinet&&this.hasStore()?(this._trigger("loadingFromCache"),this.__storage=this.getStore()):(this.__storage=this.__storage||t,this.options.shareCabinet&&this.setStore(this.__storage),this.options.autoload?this.load(!1):this.status=l),this.status="mounted",this._trigger("mounted"),this},t.prototype.isVacant=function(){return this.status===l},t.prototype.set=function(t,e){return[h,"clearing"].indexOf(this.status)>-1?(this._trigger("writeLock"),this.__tempStorage=this.__tempStorage||(this.__tempStorage=Object.create(null)),this.__tempStorage[t]=e,this):(this.__storage[t]=e,this._trigger("setItem",t,e),this)},t.prototype.get=function(t){let e=this.__storage[t];return this._trigger("getItem",t,e),e},t.prototype.remove=function(t){let e=!1;var o,r;return r=t=>{this.__storage.hasOwnProperty(t)&&(this.set(t,void 0),e=!0)},(o=t).forEach?o.forEach(r):r(o),this._trigger("removeItem",t,e),this},t.prototype.clear=function(t=null,e=null){e=s(e)?e:this.options.concurrence,t=s(t)?t:!!this.options.outerClear,this.status=h,this._trigger("beforeClear");let o=()=>{const o=t&&!e;if(this._trigger("beforeLocalClear",o),o)return this;const r=this.options.localInterface;r.database[r.removeItem](this.__root),this._trigger("localCleared",this.__root)};const r=[this.__root,this.__storage],i=()=>{this.status=l,this._trigger("cleared",t,e)},n=(o,r="")=>{this._trigger("error","clear","cloudClearings",r),this.status=l,this._trigger("cleared",t,e),console.error(`[Lycabinet]: Failed to Clear the cabinet "${this.__root}" on cloud. ${o}`)};try{o(),t?this.options.outerClear(r,i,n):(this.status=l,this._trigger("cleared",t,e))}catch(t){n(t,"unknown")}return this},t.prototype.load=function(t=!1,e=null,o=null){o=s(o)?o:this.options.concurrence,e=s(e)?e:!!this.options.outerLoad,this.status=h,this._trigger("beforeLoad");let r=()=>{let r=null;const n=e&&!o;if(this._trigger("beforeLocalLoad",n),n)return this;const s=this.options.localInterface;let a=s.database[s.getItem](this.__root);a=this._trigger("localLoaded",a),r=JSON.parse(a),t?i(this.__storage,r):Object.assign(this.__storage,r)};const n=[this.__root,this.__storage],c=r=>{if(!s(r)||!a(r))throw new Error("[Lycabinet]: Load cabinet with empty 'data' which type is "+typeof r);t?i(this.__storage,r):Object.assign(this.__storage,r),this.status=l,this._trigger("loaded",e,o)},u=(t,r="")=>{this._trigger("error","load","cloudLoadings",r),this.status=l,this._trigger("loaded",e,o),console.error(`[Lycabinet]: Failed to Load the cabinet "${this.__root}" on cloud. ${t}`)};try{r(),e?this.options.outerLoad(n,c,u):(this.status=l,this._trigger("loaded",e,o))}catch(t){u(t,"unknown")}return this},t.prototype.save=function(t=null,e=null){let o=this.options.saveMutex&&!this.isVacant();if(this._trigger("beforeSave",o),o)return this._trigger("busy"),this.options.autoLazy&&this.lazySave(t,e),this;t=s(t)?t:!!this.options.outerSave,e=s(e)?e:this.options.concurrence,this.status="saving";let r=()=>{const o=t&&!e;if(this._trigger("beforeLocalSave",o),o)return this;const r=this.options.localInterface;let i=JSON.stringify(this.__storage);i=this._trigger("localSaved",i),r.database[r.setItem](this.__root,i)};const i=[this.__root,this.__storage],n=()=>{this.status=l,this._trigger("saved",t,e)},a=(o,r="cloudSavings")=>{this._trigger("error","save",r),this.status=l,this._trigger("saved",t,e),console.error(`[Lycabinet]: Failed to Save the cabinet "${this.__root}" on cloud. ${o}`)};try{r(),t?this.options.outerSave(i,n,a):(this.status=l,this._trigger("saved",t,e))}catch(t){a(t,"unknown")}return this},t.prototype.forEach=function(t){let e,o=0;for(let r in this.__storage)e=this.__storage[r],t(e,o++)},t.prototype.map=function(t){let e,o=0;for(let r in this.__storage)e=this.__storage[r],this.__storage[r]=t(e,o++)}}(p),function(t){var e;t.prototype.lazySave=(e=0,function(...t){var o=(new Date).getTime();let r=o-e>5e3;return this._trigger("lazySave",r),r&&(e=o,console.log("Lazy executed!",o,e,r),this.save(...t)),this}),t.prototype.lazySet=function(t,e,...o){return this.set(t,e).lazySave(...o),this}}(p),function(t){t.prototype._mixins=[],t.mixin=function(e){return t.prototype._mixins.push(e),this},t.prototype.__install=function(...e){e.unshift(this),t.prototype._mixins.forEach((t=>{t.apply(t,e)}))}}(p),function(t){t.install=function(e,o){t.mixin((function(t){n(t.options,{useLaction:{lazyOrbitId:-1}}),e.registerHook({name:t.__root+"_lazysave",once:!0,debounce:!0,actions:(...e)=>{t.save(...e)}})})),t.prototype.lazySave=function(...t){return t.unshift(`${this.__root}_lazysave`),e.bubble(t,this.options.useLaction.lazyOrbitId),this}}}(p),function(t){t.prototype.delete=t.prototype.remove,t.prototype.read=t.prototype.get,t.prototype.storage=t.prototype.getStore}(p),function(t){t.mixin((function(t){const e=t.options;e.includes&&e.excludes?this.setFilter():n(e,{includes:[],excludes:[]})})),t.prototype.setFilter=function(){const t=this;Object.defineProperty(this.getStore(),"toJSON",{configurable:!0,enumerable:!1,value:function(){console.log(t);let e=Object.create(null);if(t.options.includes.length>0){let o=[];t.options.includes.forEach(((r,i)=>{let n=o[i]=r.split("."),a=t.__storage;n.forEach(((t,o)=>{a=a[n[o]],o+1<n.length&&s(a)?s(e[n[o]])?Object.assign(e[n[o]],a):e[n[o]]={}:e[n[o]]=a}))}))}else Object.assign(e,t.__storage);let o=[];return t.options.excludes.forEach(((t,r,i)=>{let n=o[r]=t.split("."),a=e;for(let t=0;t<n.length&&s(e[n[0]])&&s(a[n[t]]);t++)a=a[n[t]],t===i.length-1&&(a=void 0)})),e}})}}(p),function(t){t.prototype.initObserver=function(t={}){n(t,{lazy:!0,initWatch:!0,deepWatch:!0,shallowWatch:!1});const e=this;if(u=()=>{e._trigger("setItem"),t.lazy?e.lazySave():e.save()},!t.initWatch)return!1;this.__storage=g(this.__storage,t.deepWatch,t.shallowWatch)},t.$set=function(t,e,o=!1,r){t[e]=_(t[e],o,r)}}(p),function(t){t.mixin((function(t){t._on("localLoaded",(function(t,e){let r=e.length?o(e,-1):t;return r||(r="{}"),r})),t._on("localSaved",(function(t,e){return e.length?o(e,-1):t}))})),t.mixin((function(t){t._on("setItem",(function(){this._dirty=!0})),t._on("saved",(function(){this._dirty=!1}))}));var e={};r((t=>{if(!e.cabinetIns)return console.warn("cabinetIns is not mouted!"),!0;const{cabinetIns:o}=e;[o.__root,f].indexOf(t.key)>-1&&o.load(!0,!1,!0)})),t.mixin((function(t){e.cabinetIns=t,function(t,e){let o=null;for(let r in e)o=t[r],s(o)||(t[r]=e[r])}(t.options,{autoNotifyTabs:!1}),t._on("saved",(function(t,e){if(this.options.autoNotifyTabs){if(t&&!e)return!1;this.notifyTabs()}}))})),t.prototype.notifyTabs=function(){const t=(new Date).getTime();window.localStorage.setItem(f,t+"")}}(p),function(t){t.mixin((function(t){t._on("localLoaded",(function(t,e){return e.length?o(e,-1):t})),t._on("localSaved",(function(t,e){return e.length?o(e,-1):t}))}))}(p);const d=p;return e.default})()}));
//# sourceMappingURL=lycabinet.min.js.map