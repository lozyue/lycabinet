var t={d:(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>w});const o=function(t,e){return void 0===t[e=(t.length+e)%t.length]&&p&&console.error(`The index ${e} in array ${t.toString()} is overflowed!`),t[e]};function n(t,e,o=null){let n=t,r="",i=0;for(;i<e.length-1;i++)if(r=e[i],l(n[r])){if(!u(n[r]))return i;n=n[r]}else n=n[r]={};return r=e[i],g(o)?o(n,r):n[r]=o,!0}const r=(()=>{const t=[];return window.addEventListener("storage",(e=>{t.forEach((t=>{t(e)}))}),!1),(e,o=!1)=>{o?d(t,e):t.push(e)}})(),i=function(...t){let e;return t.reduce(((t,o)=>{for(let e in o)t[e]&&h(t[e])?i(t[e],o[e]):t[e]=o[e];return e=t,t}),t[0]),e},s=function(t,e,o=null){for(let n in e)t[n]&&h(t[n])?s(t[n],e[n]):t[n]=o?o(t[n],e[n]):e[n];return t};function a(t,e){if(!t)return e;let o=null;for(let n in e)if(o=t[n],l(o)){if(!h(o))continue;a(o,e[n])}else t[n]=e[n];return t}function c(t,e=Object.create(null),o=!0){if(h(t)){var n=e;for(var r in t)n[r]=c(t[r]);return n}return _(t)?t.slice():o&&g(t)?Object.create(t.prototype).constructor:t}const l=t=>null!=t,u=t=>t instanceof Object||"object"==typeof t,h=t=>"[object Object]"===Object.prototype.toString.call(t),_=t=>Array.isArray&&Array.isArray(t)||t instanceof Array||"object"==typeof t&&"Array"===Object.prototype.toString.call(t).slice(-6,-1),g=t=>t instanceof Function;var d=(t,e)=>{if(t.length){let o=t.indexOf(e);if(o>-1)return t.splice(o,1)}};const f="[Lycabinet]: ",p=!1;function y(t,e,o){let n=Object.create(null);if(e.length>0){let o=[];e.forEach(((e,r)=>{let i=o[r]=e.split("."),s=t,a=n;i.forEach(((t,e)=>{s=s[t],e+1<i.length&&l(s)?l(a[t])||(a[t]={}):a[t]=s,a=a[t]}))}))}else Object.assign(n,t);let r=[],i=c(n);return o.forEach(((t,e,o)=>{let n=r[e]=t.split("."),s=i;for(let t=0;t<n.length&&(p&&console.log({pointer:s,current:n[t]}),l(s[n[t]]));t++)t===n.length-1&&(s[n[t]]=void 0),s=s[n[t]]})),n=i,n}let b=null;function v(t,e=!0,o=!1){const n=[],r=t=>{n.unshift(t);for(let e in t)h(t[e])&&r(t[e])};return r(t),n.forEach(((t,n,r)=>{for(let i in t)h(t[i])&&(r[n][i]=m(t[i],e,o))})),m(t,e,o)}function m(t,e=!1,o=!0){let n=Object.create(null);n._parent=null,n.triggers=[],n.value=t;const r={enumerable:!1,configurable:!0,writable:!1},i=t=>n.triggers.push(t),s=t=>d(n.triggers,t),a=["$addListener","$removeListener"];a.forEach(((t,e)=>{n[t]={value:null},Object.defineProperty(n,t,{value:e?s:i,...r})}));const c=n.value;return new Proxy(t,{get:(t,e,o)=>(p&&console.info("Getted",t,e,o,n),a.indexOf(e)>-1?n[e]:c[e]),set(t,r,i,s){p&&console.info("Setted",t,r,s,n);const a=c[r];if(e?h(i)&&(c[r]=o?m(i,!1,!0):v(i,e,!1)):c[r]=i,i!==a){let t=n.triggers;for(let e=0;e<t.length;e++){if(!g(t[e]))throw new Error("The get proxy handler listener added in target is Not a Function which type is "+typeof t[e]);t[e](r,i,a)}null!==b&&b()}return!0}})}function S(...t){this.__init.apply(this,t)}!function(t){t.prototype._mixins=[],t.mixin=function(e){return t.prototype._mixins.push(e),this},t.prototype.__install=function(...e){e.unshift(this),t.prototype._mixins.forEach((t=>{t.apply(t,e)}))}}(S),function(t){let e=null;t.mixin((function(n){let r=null;n!==e&&(r=Object.create(null)),e=n,n._on=function(t,e){if(p&&!g(e))throw new Error("[Laction]:The second parameter of _on method must be a callback function!");r||(r=Object.create(null)),(r[t]||(r[t]=[])).push(e)},n._off=function(t,e){const o=r[t]||(r[t]=[]);if(!0===o._lock)return Promise.resolve().then((()=>d(o,e)));d(o,e)},n._trigger=function(t,...e){const n=r[t]||(r[t]=[]);n._counter||(n._counter=0),n._counter++,n._lock=!0;const i=[];let s=n.length;e.push(i);for(let t=0;t<s;t++){let o=n[t].apply(this,e);l(o)&&i.push(o)}return n._lock=!1,i.length>0?o(i,-1):e.length>1?o(e,-2):null},n._ready=function(t,e,o=!1){const i=r[t]||(r[t]=[]);if(i._counter&&!1!==o&&n._isHappened(t,~~o))e(i._counter);else{var s=function(...o){this._off(t,s),e.apply(this,o)};this._on(t,s)}},n._next=function(t,e,o=!1){r[t]||(r[t]=[]);var n=function(...o){this._off(t,n),e.apply(this,o)};this._on(t,n)},n._isHappened=function(t,e=1){return(r[t]||(r[t]=[]))._counter>=e},n._count=function(t){return(r[t]||(r[t]=[]))._counter},n._setlog=function(){return!!t.DEBUG&&(new Set(Object.keys(r).concat(["created","mounted","beforeLoad","beforeLocalLoad","localLoaded","loaded","loadFromCache","storageSync","setItem","writeLock","writeBackflow","getItem","removeItem","lazySave","beforeSave","beforeLocalSave","localSaved","saved","busy","beforeClear","beforeLocalClear","localCleared","cleared","error","destroyed"])).forEach((e=>{let o=r[e]&&r[e]._logHandle;o&&this._off(e,o);const n=()=>{t.DEBUG&&console.log(`[Lycabinet${t.SeparateLog?"-"+this.__root:""}]:Triggered the event: '${e}'`)};this._on(e,n),r[e]._logHandle=n})),!0)},n._on("destroyed",(()=>{for(let t in r)delete r[t]}))}))}(S),function(t){const e=Object.create(null),o=Object.create(null);p&&(window.__cabinet=e);const n=t.prototype;n.getCabinet=function(){return this.__storage},n.isIdentical=function(){return this.__storage===e[this.__root]},n.hasStore=function(){return l(e[this.__root])&&h(e[this.__root])},n.getStore=function(){return e[this.__root]},n.setStore=function(t){e[this.__root]=t},n.removeStore=function(){return!(this.options.useSharedCabinet||!this.options.shareCabinet||!this.isIdentical()||o[this.__root].size<=0||(e[this.__root]=void 0,0))},t.$removeStore=function(t){e[t]=void 0},p&&(t.$getStore=function(t){return e[t]}),t.mixin((t=>{t._on("created",(()=>{o[t.__root]||(o[t.__root]=new Set),o[t.__root].add(t)})),t._on("destoryed",(()=>{o[t.__root].delete(t),o[t.__root].size<=0&&(o[t.__root]=void 0)}))}))}(S),function(t){t.DEBUG=!0,t.SeparateLog=!1;const e=t.prototype;e.__init=function(t,e={}){if(e.initStorage&&!h(e.initStorage))throw new Error(`${f}The type of the provided option "initStorage" must be an Object!`);if("string"!=typeof(o=t)||o.constructor!=String)throw new Error(`${f}The param "root" should be an string, than type ${typeof t}!`);var o;this.__root=(t||"lycabinet")+"";const n={root:this.__root,autoload:!0,lazyPeriod:~~e.lazyPeriod||5e3,saveMutex:!0,autoLazy:!0,logEvent:!1,useSharedCabinet:!0,shareCabinet:!0,deepMerge:!1,customMerge:null,localInterface:{database:window.localStorage,getItem:"getItem",setItem:"setItem",removeItem:"removeItem"},concurrent:!!(e.outerLoad||e.outerSave||e.outerClear),outerLoad:null,outerSave:null,outerClear:null};this.options=i(n,e),this.__install(n),n.logEvent&&this._setlog(),this.status="created",this._trigger("created"),n.autoload&&this._init(e.initStorage||Object.create(null))},e._init=function(t=null){const e=this.options;t=t||e.initStorage||Object.create(null);const o=function(){var t;(t=this.__tempStorage)&&(_(t)?t.length:Object.keys(t).length)&&(i(this.__storage,this.__tempStorage),this.__tempStorage=Object.create(null),this._trigger("writeBackflow"))};this._on("loaded",o),this._on("cleared",o);const n=e.useSharedCabinet&&this.hasStore();return n?(this.__storage=this.getStore(),e.deepMerge?s(t,this.__storage,e.customMerge):Object.assign(t,this.__storage),this._trigger("loadFromCache",this.__storage)):(this.__storage=this.__storage||t,e.shareCabinet&&this.setStore(this.__storage)),this.status="mounted",this._trigger("mounted"),n?this.status="idle":e.autoload?this.load():this.status="idle",this},e.isVacant=function(){return"idle"===this.status},e.set=function(t,e){return["loading","clearing"].indexOf(this.status)>-1?(this._trigger("writeLock"),this.__tempStorage=this.__tempStorage||(this.__tempStorage=Object.create(null)),n(this.__tempStorage,t.split("."),e),this):(n(this.__storage,t.split("."),e),this._trigger("setItem",t,e),this)},e.get=function(t){let e=function(t,e){let o=t,n="";for(let t=0;t<e.length;t++)if(n=e[t],o=o&&o[n],void 0===o)return;return o}(this.__storage,t.split("."));return this._trigger("getItem",t,e),e},e.remove=function(t){let e=!1;var o,n;return n=t=>{this.__storage.hasOwnProperty(t)&&(this.set(t,void 0),e=!0)},(o=t).forEach?o.forEach(n):n(o),e&&this._trigger("removeItem",t,e),this},e.clear=function(t={}){const e=l(t.concurrent)?t.concurrent:this.options.concurrent,o=l(t.onCloud)?t.onCloud:!!this.options.outerClear;this.status="loading",this._trigger("beforeClear");let n=()=>{const t=o&&!e;if(this._trigger("beforeLocalClear",t),t)return p&&console.log(`${f}The local clear action is ignored by options: concurrent:false.`),this;const n=this.options.localInterface;n.database[n.removeItem](this.__root),this._trigger("localCleared",this.__root)};const r=n=>{this.status="idle",t.onceDone&&t.onceDone(n,o),this._trigger("cleared",o,e)},i=[this.__root,this.__storage],s=()=>{r(!0)},a=(t,e="cloudClearings")=>{r(!1),!0!==this._trigger("error","clear",e)&&o&&console.error(`${f}Failed tfo Clear the cabinet "${this.__root}" on cloud. ${t}`)};try{t.reset&&Reflect.ownKeys(this.__storage).forEach((t=>{delete this.__storage[t]})),n(),o?this.options.outerClear(i,s,a):r(!0)}catch(t){a(t,"unknown")}return this},e.load=function(t={}){const e=l(t.concurrent)?t.concurrent:this.options.concurrent,o=l(t.onCloud)?t.onCloud:!!this.options.outerLoad,n=l(t.deepMerge)?~~t.deepMerge:this.options.deepMerge;this.status="loading",this._trigger("beforeLoad");let r=()=>{let r=null;const a=o&&!e;if(this._trigger("beforeLocalLoad",a),a)return p&&console.log("${LogToken}The local load action is ignored by options: concurrent=false."),this;const c=this.options.localInterface;let l=c.database[c.getItem](this.__root);l=this._trigger("localLoaded",l),r=JSON.parse(l),n?t.disableMerge?i(this.__storage,r):s(this.__storage,r,this.options.customMerge):Object.assign(this.__storage,r)};const a=n=>{this.status="idle",t.onceDone&&t.onceDone(n,o),this._trigger("loaded",o,e)},c=[this.__root,this.__storage],u=e=>{if(!l(e)||!h(e))throw new Error(`${f}Load cabinet with empty 'data' which type is ${typeof e}`);n?t.disableMerge?i(this.__storage,e):s(this.__storage,e,this.options.customMerge):Object.assign(this.__storage,e),a(!0)},_=(t,e="cloudLoadings")=>{a(!1),!0!==this._trigger("error","load",e)&&o&&console.error(`${f}Failed to Load the cabinet "${this.__root}" on cloud. ${t}`)};try{r(),o?this.options.outerLoad(c,u,_):a(!0)}catch(t){_(t,"unknown")}return this},e.save=function(t={}){const e=l(t.onCloud)?t.onCloud:!!this.options.outerSave,o=l(t.concurrent)?t.concurrent:this.options.concurrent;let n=this.options.saveMutex&&!this.isVacant();if(this._trigger("beforeSave",n),n)return p&&console.log(`${f}The 'save' manipulation is deserted for busy. Current Status: ${this.status} .Set 'saveMutex' false to disable it.`),this._trigger("busy",this.status),this.options.autoLazy&&this.lazySave(e,o),this;this.status="saving";let r=()=>{const t=e&&!o;if(this._trigger("beforeLocalSave",t),t)return p&&console.log("${LogToken}The local save action is ignored by options: concurrent=false."),this;let n=JSON.stringify(this.__storage);n=this._trigger("localSaved",n);const r=this.options.localInterface;r.database[r.setItem](this.__root,n)};const i=n=>{this.status="idle",t.onceDone&&t.onceDone(n,e),this._trigger("saved",e,o)},s=[this.__root,this.__storage],a=()=>{i(!0)},c=(t,o="cloudSavings")=>{i(!1),!0!==this._trigger("error","save",o)&&e&&console.error(`${f}Failed to Save the cabinet "${this.__root}" on cloud. ${t}`)};try{r(),e?this.options.outerSave(s,a,c):i(!0)}catch(t){c(t,"unknown")}return this},e.forEach=function(t){let e;const o=this.__storage;for(let n in o)e=o[n],t(e,n,o);return this},e.map=function(t){let e;const o=this.__storage;for(let n in o)e=o[n],o[n]=t(e,n,o);return o},e.destroy=function(t=!1){t&&this.clear({reset:!0,onCloud:!1,concurrent:!1}),this.removeStore(),this.status="destroyed",this._trigger("destroyed")}}(S),function(t){var e,o;t.prototype.lazySave=(o=0,function(...t){var n=(new Date).getTime();let r=n-o>this.options.lazyPeriod;return this._trigger("lazySave",r),clearTimeout(e),r?(p&&console.log("Lazy executed!",n,o,r),this.save(...t)):e=setTimeout((()=>{this.save(...t)}),n-o),o=n,this}),t.prototype.lazySet=function(t,e,...o){return this.set(t,e).lazySave(...o),this}}(S),function(t){t.install=function(e,o){t.mixin((function(t){a(t.options,{useLaction:{lazyOrbitId:-1}});let o=t.__root+"_lazy";const n=e.testHookName(o,!0);t.getLazyKey=()=>n,t._lazyKey=n,e.registerHook({name:n,once:!0,debounce:!0,action:(...e)=>{t.save(...e)}}),t._on("destroyed",(()=>{e.unregisterHook(n)}))})),t.prototype.lazySave=function(...t){return t.unshift(this._lazyKey),e.bubble(t,this.options.useLaction.lazyOrbitId,!1),this._trigger("lazySave"),this}}}(S),function(t){const e=t.prototype;e.delete=e.remove,e.read=e.get,e.write=e.set,e.storage=e.getCabinet,e.isConsistent=e.isIdentical}(S),function(t){const e=t.prototype;t.mixin((function(t){const e=t.options;(e.includes||e.excludes)&&t._ready("mounted",(()=>{t.setFilter()})),a(e,{includes:[],excludes:[]})})),e.setFilter=function(){const t=this;Object.defineProperty(this.getCabinet(),"toJSON",{configurable:!0,enumerable:!1,value:function(){return y(t.getCabinet(),t.options.includes,t.options.excludes)}})},t.$filter=y}(S),function(t){const e=t.prototype;e.initObserver=function(t={}){if(Object.assign(t,{deepMerge:!0}),a(t,{lazy:!0,initWatch:!0,deepWatch:!0,shallowWatch:!1}),b=()=>{t.lazy?this.lazySave():this.save()},!t.initWatch)return!1;this.__storage=v(this.__storage,t.deepWatch,t.shallowWatch),this.setStore(this.__storage)},t.$active=function(t,e,o=!1,r=!0){return n(t,e,((t,e)=>{h(t[e])||(t[e]={}),p&&t[e].$addListener&&console.warn(`${f}The target have been converted before!`,t[e]),t[e]=m(t[e],o,r)}))},e.$active=function(e,o=!1,n=!0){return t.$active(this.__storage,e.split("."),o,n)}}(S),function(t){t.mixin((function(t){t._on("localLoaded",(function(t,e){let n=e.length?o(e,-1):t;return n||(n="{}"),n})),t._on("localSaved",(function(t,e){return e.length?o(e,-1):t}))})),t.mixin((function(t){t._on("setItem",(function(){this._dirty=!0})),t._on("saved",(function(){this._dirty=!1}))}));var e=[];r((t=>{let o,n=t.key;"cabinetSyncTabs"===t.key&&(n=t.newValue.slice(-t.newValue.lastIndexOf("|")));for(let t=0;t<e.length;t++){if(o=e[t],!o.options.autoNotifyTabs)return void(p&&console.log("TabSync is disabled!"));if(!o.useLoadCache&&[o.__root].indexOf(n)>-1){p&&console.log("[Lycabinet]: Synchronizing data from other tabs..."),o.load({onCloud:!1,concurrent:!0,deepMerge:!0,disableMerge:!0}),o._trigger("storageSync");break}}})),t.mixin((function(t){e.push(t),t._on("destroyed",(()=>{d(e,t)})),t._on("loadFromCache",(function(){this.useLoadCache=!0})),function(t,e){let o=null;for(let n in e)o=t[n],l(o)||(t[n]=e[n])}(t.options,{autoNotifyTabs:!0}),t._on("saved",(function(t,e){if(this.options.autoNotifyTabs){if(t&&!e)return!1;this.notifyTabs()}}))})),t.prototype.notifyTabs=function(){const t=(new Date).getTime(),e=window.localStorage;try{e.setItem("cabinetSyncTabs",`${this.__root}|${t}`)}catch(t){t instanceof DOMException&&(22===t.code||1014===t.code||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name)&&e&&0!==e.length&&console.error("[lycabinet]: Sync storage from tabs failed cause LocalStorage is not supportted!",t)}}}(S),function(t){t.mixin((function(t){t._on("localLoaded",(function(t,e){return e.length?o(e,-1):t})),t._on("localSaved",(function(t,e){return e.length?o(e,-1):t}))}))}(S);const w=S;var O=e.default;export{O as default};
//# sourceMappingURL=lycabinet.esm.min.js.map