!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("Lycabinet",[],e):"object"==typeof exports?exports.Lycabinet=e():t.Lycabinet=e()}(self,(function(){return(()=>{"use strict";var t={d:(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>c}),(()=>{const t=[];window.addEventListener("storage",(e=>{t.forEach((t=>{t(e)}))}),!1)})();const o=function(...t){let e;return t.reduce(((t,r)=>{for(let e in r)t[e]&&i(t[e])?o(t[e],r[e]):t[e]=r[e];return e=t,t}),t[0]),e},r=t=>null!=t,i=t=>"[object Object]"===Object.prototype.toString.call(t);const n="idle",s="loading";function a(...t){this.__init.apply(this,t)}!function(t){const e=Object.create(null);t.prototype.hasStore=function(){return r(e[this.__root])&&i(e[this.__root])},t.prototype.getStore=function(){return e[this.__root]},t.prototype.setStore=function(t){e[this.__root]=t},t.prototype.removeStore=function(){e[this.__root]=void 0},t.$removeStore=function(t){e[t]=void 0}}(a),function(t){t.prototype._setlog=new Function,t.prototype._once=new Function,t.prototype._trigger=new Function,t.prototype._off=new Function,t.prototype._on=new Function}(a),function(t){const e=t.prototype;e.__init=function(t,e={}){if(e.initStorage&&!i(e.initStorage))throw new Error("[Lycabinet]:The type of the provided option `initStorage` must be an Object!");if("string"!=typeof(r=t)||r.constructor!=String)throw new Error(`[Lycabinet]: The param "root" should be an string, than type ${typeof t}!`);var r;this.__root=(t||"lycabinet")+"";const n={root:this.__root,autoload:!0,lazyPeriod:~~e.lazyPeriod||5e3,saveMutex:!0,autoLazy:!0,logEvent:!1,useSharedCabinet:!0,shareCabinet:!0,deepMerge:!1,localInterface:{database:window.localStorage,getItem:"getItem",setItem:"setItem",removeItem:"removeItem"},concurrent:!(e.outerLoad&&e.outerSave&&e.outerClear),outerLoad:([t,e],o,r)=>{o({})},outerSave:([t,e],o,r)=>{o()},outerClear:([t,e],o,r)=>{o()}};this.options=o(n,e),this.__install(this.options),this.options.logEvent&&this._setlog(),this.status="created",this._trigger("created"),this.options.autoload&&this._init(e.initStorage||Object.create(null))},e._init=function(t=Object.create(null)){const e=function(){var t,e;(t=this.__tempStorage)&&(e=t,Array.isArray&&Array.isArray(e)||e instanceof Array||"object"==typeof e&&"Array"===Object.prototype.toString.call(e).slice(-6,-1)?t.length:Object.keys(t).length)&&(o(this.__storage,this.__tempStorage),this.__tempStorage=Object.create(null),this._trigger("writeBackflow"))};return this._on("loaded",e),this._on("cleared",e),this.options.useSharedCabinet&&this.hasStore()?(this.__storage=this.getStore(),Object.assign(t,this.__storage),this._trigger("loadFromCache")):(this.__storage=this.__storage||t,this.options.shareCabinet&&this.setStore(this.__storage),this.options.autoload?this.load():this.status=n),this.status="mounted",this._trigger("mounted"),this},e.isVacant=function(){return this.status===n},e.set=function(t,e){return[s,"clearing"].indexOf(this.status)>-1?(this._trigger("writeLock"),this.__tempStorage=this.__tempStorage||(this.__tempStorage=Object.create(null)),this.__tempStorage[t]=e,this):(this.__storage[t]=e,this._trigger("setItem",t,e),this)},e.get=function(t){let e=this.__storage[t];return this._trigger("getItem",t,e),e},e.remove=function(t){let e=!1;var o,r;return r=t=>{this.__storage.hasOwnProperty(t)&&(this.set(t,void 0),e=!0)},(o=t).forEach?o.forEach(r):r(o),this._trigger("removeItem",t,e),this},e.clear=function(t={}){const e=r(t.concurrent)?t.concurrent:this.options.concurrent,o=r(t.onCloud)?t.onCloud:!!this.options.outerClear;this.status=s,this._trigger("beforeClear");let i=()=>{const t=o&&!e;if(this._trigger("beforeLocalClear",t),t)return this;const r=this.options.localInterface;r.database[r.removeItem](this.__root),this._trigger("localCleared",this.__root)};const a=[this.__root,this.__storage],c=()=>{this.status=n,this._trigger("cleared",o,e),t.onceDone&&t.onceDone(!0,o)},h=(r,i="")=>{this._trigger("error","clear","cloudClearings",i),this.status=n,this._trigger("cleared",o,e),console.error(`[Lycabinet]: Failed to Clear the cabinet "${this.__root}" on cloud. ${r}`),t.onceDone&&t.onceDone(!1,o)};try{i(),o?this.options.outerClear(a,c,h):(this.status=n,this._trigger("cleared",o,e),t.onceDone&&t.onceDone(!0,o))}catch(e){h(e,"unknown"),t.onceDone&&t.onceDone(!1,o)}return this},e.load=function(t={}){const e=r(t.concurrent)?t.concurrent:this.options.concurrent,a=r(t.onCloud)?t.onCloud:!!this.options.outerLoad,c=r(t.deepMerge)?~~t.deepMerge:this.options.deepMerge;this.status=s,this._trigger("beforeLoad");let h=()=>{let t=null;const r=a&&!e;if(this._trigger("beforeLocalLoad",r),r)return this;const i=this.options.localInterface;let n=i.database[i.getItem](this.__root);n=this._trigger("localLoaded",n),t=JSON.parse(n),c?o(this.__storage,t):Object.assign(this.__storage,t)};const _=[this.__root,this.__storage],u=s=>{if(!r(s)||!i(s))throw new Error("[Lycabinet]: Load cabinet with empty 'data' which type is "+typeof s);c?o(this.__storage,s):Object.assign(this.__storage,s),this.status=n,this._trigger("loaded",a,e),t.onceDone&&t.onceDone(!0,a)},g=(o,r="")=>{this._trigger("error","load","cloudLoadings",r),this.status=n,this._trigger("loaded",a,e),console.error(`[Lycabinet]: Failed to Load the cabinet "${this.__root}" on cloud. ${o}`),t.onceDone&&t.onceDone(!1,a)};try{h(),a?this.options.outerLoad(_,u,g):(this.status=n,this._trigger("loaded",a,e),t.onceDone&&t.onceDone(!0,a))}catch(e){g(e,"unknown"),t.onceDone&&t.onceDone(!1,a)}return this},e.save=function(t={}){const e=r(t.onCloud)?t.onCloud:!!this.options.outerSave,o=r(t.concurrent)?t.concurrent:this.options.concurrent;let i=this.options.saveMutex&&!this.isVacant();if(this._trigger("beforeSave",i),i)return this._trigger("busy"),this.options.autoLazy&&this.lazySave(e,o),this;this.status="saving";let s=()=>{const t=e&&!o;if(this._trigger("beforeLocalSave",t),t)return this;const r=this.options.localInterface;let i=JSON.stringify(this.__storage);i=this._trigger("localSaved",i),r.database[r.setItem](this.__root,i)};const a=[this.__root,this.__storage],c=()=>{this.status=n,this._trigger("saved",e,o),t.onceDone&&t.onceDone(!0,e)},h=(r,i="cloudSavings")=>{this._trigger("error","save",i),this.status=n,this._trigger("saved",e,o),console.error(`[Lycabinet]: Failed to Save the cabinet "${this.__root}" on cloud. ${r}`),t.onceDone&&t.onceDone(!1,e)};try{s(),e?this.options.outerSave(a,c,h):(this.status=n,this._trigger("saved",e,o),t.onceDone&&t.onceDone(!0,e))}catch(o){h(o,"unknown"),t.onceDone&&t.onceDone(!1,e)}return this},e.forEach=function(t){let e,o=0;for(let r in this.__storage)e=this.__storage[r],t(e,o++)},e.map=function(t){let e,o=0;for(let r in this.__storage)e=this.__storage[r],this.__storage[r]=t(e,o++)},e.destroy=function(){this._trigger("destroied")}}(a),function(t){var e;t.prototype.lazySave=(e=0,function(...t){var o=(new Date).getTime();let r=o-e>5e3;return this._trigger("lazySave",r),r&&(e=o,this.save(...t)),this}),t.prototype.lazySet=function(t,e,...o){return this.set(t,e).lazySave(...o),this}}(a),function(t){t.prototype._mixins=[],t.mixin=function(e){return t.prototype._mixins.push(e),this},t.prototype.__install=function(...e){e.unshift(this),t.prototype._mixins.forEach((t=>{t.apply(t,e)}))}}(a);const c=a;return e.default})()}));
//# sourceMappingURL=lycabinet.light.min.js.map