var t={d:(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};function o(t,e,o=null){let r=t,i="",a=0;for(;a<e.length-1;a++)if(i=e[a],s(r[i])){if(!n(r[i]))return a;r=r[i]}else r=r[i]={};return i=e[a],c(o)?o(r,i):r[i]=o,!0}t.d(e,{default:()=>u}),(()=>{const t=[];window.addEventListener("storage",(e=>{t.forEach((t=>{t(e)}))}),!1)})();const r=function(...t){let e;return t.reduce(((t,o)=>{for(let e in o)t[e]&&a(t[e])?r(t[e],o[e]):t[e]=o[e];return e=t,t}),t[0]),e},i=function(t,e,o=null){for(let r in e)t[r]&&a(t[r])?i(t[r],e[r]):t[r]=o?o(t[r],e[r]):e[r];return t},s=t=>null!=t,n=t=>t instanceof Object||"object"==typeof t,a=t=>"[object Object]"===Object.prototype.toString.call(t),c=t=>t instanceof Function;const h="[Lycabinet]: ";function l(...t){this.__init.apply(this,t)}!function(t){const e=Object.create(null),o=Object.create(null),r=t.prototype;r.getCabinet=function(){return this.__storage},r.isIdentical=function(){return this.__storage===e[this.__root]},r.hasStore=function(){return s(e[this.__root])&&a(e[this.__root])},r.getStore=function(){return e[this.__root]},r.setStore=function(t){e[this.__root]=t},r.removeStore=function(){return!(this.options.useSharedCabinet||!this.options.shareCabinet||!this.isIdentical()||o[this.__root].size<=0||(e[this.__root]=void 0,0))},t.$removeStore=function(t){e[t]=void 0},t.mixin((t=>{t._on("created",(()=>{o[t.__root]||(o[t.__root]=new Set),o[t.__root].add(t)})),t._on("destoryed",(()=>{o[t.__root].delete(t),o[t.__root].size<=0&&(o[t.__root]=void 0)}))}))}(l),function(t){const e=t.prototype,o=Function();["isHappened","setlog","ready","next","count","trigger","off","on"].forEach((t=>{e["_"+t]=o}))}(l),function(t){t.DEBUG=!0,t.SeparateLog=!1;const e=t.prototype;e.__init=function(t,e={}){if(e.initStorage&&!a(e.initStorage))throw new Error(`${h}The type of the provided option "initStorage" must be an Object!`);if("string"!=typeof(o=t)||o.constructor!=String)throw new Error(`${h}The param "root" should be an string, than type ${typeof t}!`);var o;this.__root=(t||"lycabinet")+"";const i={root:this.__root,autoload:!0,lazyPeriod:~~e.lazyPeriod||5e3,saveMutex:!0,autoLazy:!0,logEvent:!1,useSharedCabinet:!0,shareCabinet:!0,deepMerge:!1,customMerge:null,localInterface:{database:window.localStorage,getItem:"getItem",setItem:"setItem",removeItem:"removeItem"},concurrent:!!(e.outerLoad||e.outerSave||e.outerClear),outerLoad:null,outerSave:null,outerClear:null};this.options=r(i,e),this.__install(i),i.logEvent&&this._setlog(),this.status="created",this._trigger("created"),i.autoload&&this._init(e.initStorage||Object.create(null))},e._init=function(t=null){const e=this.options;t=t||e.initStorage||Object.create(null);const o=function(){var t,e;(t=this.__tempStorage)&&(e=t,Array.isArray&&Array.isArray(e)||e instanceof Array||"object"==typeof e&&"Array"===Object.prototype.toString.call(e).slice(-6,-1)?t.length:Object.keys(t).length)&&(r(this.__storage,this.__tempStorage),this.__tempStorage=Object.create(null),this._trigger("writeBackflow"))};this._on("loaded",o),this._on("cleared",o);const s=e.useSharedCabinet&&this.hasStore();return s?(this.__storage=this.getStore(),e.deepMerge?i(t,this.__storage,e.customMerge):Object.assign(t,this.__storage),this._trigger("loadFromCache",this.__storage)):(this.__storage=this.__storage||t,e.shareCabinet&&this.setStore(this.__storage)),this.status="mounted",this._trigger("mounted"),s?this.status="idle":e.autoload?this.load():this.status="idle",this},e.isVacant=function(){return"idle"===this.status},e.set=function(t,e){return["loading","clearing"].indexOf(this.status)>-1?(this._trigger("writeLock"),this.__tempStorage=this.__tempStorage||(this.__tempStorage=Object.create(null)),o(this.__tempStorage,t.split("."),e),this):(o(this.__storage,t.split("."),e),this._trigger("setItem",t,e),this)},e.get=function(t){let e=function(t,e){let o=t,r="";for(let t=0;t<e.length;t++)if(r=e[t],o=o&&o[r],void 0===o)return;return o}(this.__storage,t.split("."));return this._trigger("getItem",t,e),e},e.remove=function(t){let e=!1;var o,r;return r=t=>{this.__storage.hasOwnProperty(t)&&(this.set(t,void 0),e=!0)},(o=t).forEach?o.forEach(r):r(o),e&&this._trigger("removeItem",t,e),this},e.clear=function(t={}){const e=s(t.concurrent)?t.concurrent:this.options.concurrent,o=s(t.onCloud)?t.onCloud:!!this.options.outerClear;this.status="loading",this._trigger("beforeClear");let r=()=>{const t=o&&!e;if(this._trigger("beforeLocalClear",t),t)return this;const r=this.options.localInterface;r.database[r.removeItem](this.__root),this._trigger("localCleared",this.__root)};const i=r=>{this.status="idle",t.onceDone&&t.onceDone(r,o),this._trigger("cleared",o,e)},n=[this.__root,this.__storage],a=()=>{i(!0)},c=(t,e="cloudClearings")=>{i(!1),!0!==this._trigger("error","clear",e)&&o&&console.error(`${h}Failed tfo Clear the cabinet "${this.__root}" on cloud. ${t}`)};try{t.reset&&Reflect.ownKeys(this.__storage).forEach((t=>{delete this.__storage[t]})),r(),o?this.options.outerClear(n,a,c):i(!0)}catch(t){c(t,"unknown")}return this},e.load=function(t={}){const e=s(t.concurrent)?t.concurrent:this.options.concurrent,o=s(t.onCloud)?t.onCloud:!!this.options.outerLoad,n=s(t.deepMerge)?~~t.deepMerge:this.options.deepMerge;this.status="loading",this._trigger("beforeLoad");let c=()=>{let s=null;const a=o&&!e;if(this._trigger("beforeLocalLoad",a),a)return this;const c=this.options.localInterface;let h=c.database[c.getItem](this.__root);h=this._trigger("localLoaded",h),s=JSON.parse(h),n?t.disableMerge?r(this.__storage,s):i(this.__storage,s,this.options.customMerge):Object.assign(this.__storage,s)};const l=r=>{this.status="idle",t.onceDone&&t.onceDone(r,o),this._trigger("loaded",o,e)},u=[this.__root,this.__storage],_=e=>{if(!s(e)||!a(e))throw new Error(`${h}Load cabinet with empty 'data' which type is ${typeof e}`);n?t.disableMerge?r(this.__storage,e):i(this.__storage,e,this.options.customMerge):Object.assign(this.__storage,e),l(!0)},g=(t,e="cloudLoadings")=>{l(!1),!0!==this._trigger("error","load",e)&&o&&console.error(`${h}Failed to Load the cabinet "${this.__root}" on cloud. ${t}`)};try{c(),o?this.options.outerLoad(u,_,g):l(!0)}catch(t){g(t,"unknown")}return this},e.save=function(t={}){const e=s(t.onCloud)?t.onCloud:!!this.options.outerSave,o=s(t.concurrent)?t.concurrent:this.options.concurrent;let r=this.options.saveMutex&&!this.isVacant();if(this._trigger("beforeSave",r),r)return this._trigger("busy",this.status),this.options.autoLazy&&this.lazySave(e,o),this;this.status="saving";let i=()=>{const t=e&&!o;if(this._trigger("beforeLocalSave",t),t)return this;let r=JSON.stringify(this.__storage);r=this._trigger("localSaved",r);const i=this.options.localInterface;i.database[i.setItem](this.__root,r)};const n=r=>{this.status="idle",t.onceDone&&t.onceDone(r,e),this._trigger("saved",e,o)},a=[this.__root,this.__storage],c=()=>{n(!0)},l=(t,o="cloudSavings")=>{n(!1),!0!==this._trigger("error","save",o)&&e&&console.error(`${h}Failed to Save the cabinet "${this.__root}" on cloud. ${t}`)};try{i(),e?this.options.outerSave(a,c,l):n(!0)}catch(t){l(t,"unknown")}return this},e.forEach=function(t){let e;const o=this.__storage;for(let r in o)e=o[r],t(e,r,o);return this},e.map=function(t){let e;const o=this.__storage;for(let r in o)e=o[r],o[r]=t(e,r,o);return o},e.destroy=function(t=!1){t&&this.clear({reset:!0,onCloud:!1,concurrent:!1}),this.removeStore(),this.status="destroyed",this._trigger("destroyed")}}(l),function(t){var e,o;t.prototype.lazySave=(o=0,function(...t){var r=(new Date).getTime();let i=r-o>this.options.lazyPeriod;return this._trigger("lazySave",i),clearTimeout(e),i?this.save(...t):e=setTimeout((()=>{this.save(...t)}),r-o),o=r,this}),t.prototype.lazySet=function(t,e,...o){return this.set(t,e).lazySave(...o),this}}(l),function(t){t.prototype._mixins=[],t.mixin=function(e){return t.prototype._mixins.push(e),this},t.prototype.__install=function(...e){e.unshift(this),t.prototype._mixins.forEach((t=>{t.apply(t,e)}))}}(l),function(t){const e=t.prototype;e.delete=e.remove,e.read=e.get,e.write=e.set,e.storage=e.getCabinet,e.isConsistent=e.isIdentical}(l);const u=l;var _=e.default;export{_ as default};
//# sourceMappingURL=lycabinet.light.esm.min.js.map